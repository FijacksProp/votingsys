{% extends 'base.html' %}

{% block title %}Cast Your Vote - {{ election.title }}{% endblock %}

{% block content %}
<section class="min-h-screen py-12 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="glass-effect rounded-2xl shadow-lg p-6 mb-8 fade-in stagger-1">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 mb-2 serif-title">{{ election.title }}</h1>
                    <p class="text-slate-600">{{ election.description }}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="px-4 py-2 bg-emerald-100 text-emerald-800 rounded-lg font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {{ election.get_status_display }}
                    </div>
                </div>
            </div>
            
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 rounded-xl p-4">
                    <p class="text-sm text-blue-900 font-semibold mb-1">Election Period</p>
                    <p class="text-lg font-bold text-blue-900">{{ election.start_date|date:"M j" }} - {{ election.end_date|date:"M j, Y" }}</p>
                </div>
                <div class="bg-emerald-50 rounded-xl p-4">
                    <p class="text-sm text-emerald-900 font-semibold mb-1">Voter Status</p>
                    <p class="text-lg font-bold text-emerald-900">Verified âœ“</p>
                </div>
                <div class="bg-amber-50 rounded-xl p-4">
                    <p class="text-sm text-amber-900 font-semibold mb-1">Time Remaining</p>
                    <p class="text-lg font-bold text-amber-900">
                        {% if is_active %}
                            <span id="countdown-timer">Loading...</span>
                        {% else %}
                            Election Ended
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Important Notice -->
        <div class="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-r-2xl shadow-md mb-8 fade-in stagger-2">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-amber-600 mr-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                    <h3 class="text-lg font-bold text-amber-900 mb-2">Important Notice</h3>
                    <p class="text-amber-800 leading-relaxed">
                        Your vote is final and cannot be changed once submitted. Please review all candidates carefully before proceeding. 
                        You must vote for at least one position to submit your ballot.
                    </p>
                </div>
            </div>
        </div>
        
        {% if is_active %}
        <form method="post" id="voting-form">
            {% csrf_token %}
            {% for position in positions %}
            <div class="glass-effect rounded-2xl shadow-lg p-8 mb-8 fade-in stagger-{{ forloop.counter|add:2 }}">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-slate-900 mb-2 serif-title">{{ position.title }}</h2>
                    <p class="text-slate-600">{{ position.description|default:"Select one candidate" }}</p>
                </div>
                
                <div class="space-y-4">
                    {% for candidate in position.candidates.all %}
                    <label class="block cursor-pointer">
                        <input type="radio" name="position_{{ position.id }}" value="{{ candidate.id }}" class="peer hidden" required>
                        <div class="border-2 border-slate-200 peer-checked:border-blue-900 peer-checked:bg-blue-50 rounded-xl p-6 transition hover:shadow-lg">
                            <div class="flex items-start gap-6">
                                {% if candidate.photo %}
                                <img src="{{ candidate.photo.url }}" alt="{{ candidate.full_name }}" class="w-20 h-20 rounded-xl object-cover flex-shrink-0">
                                {% else %}
                                <div class="w-20 h-20 bg-gradient-to-br from-slate-300 to-slate-400 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                {% endif %}
                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 class="text-xl font-bold text-slate-900">{{ candidate.full_name }}</h3>
                                            <p class="text-slate-600">{{ candidate.department }}, {{ candidate.level }}</p>
                                        </div>
                                        <div class="peer-checked:block hidden">
                                            <div class="w-8 h-8 bg-blue-900 rounded-full flex items-center justify-center">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-slate-700 leading-relaxed">{{ candidate.manifesto }}</p>
                                </div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            
            <!-- Submit Button -->
            <div class="flex justify-end gap-4 fade-in stagger-4">
                <a 
                    href="{% url 'index' %}" 
                    class="px-8 py-3 bg-white border-2 border-slate-300 text-slate-700 rounded-xl font-semibold hover:shadow-lg transition"
                >
                    Cancel
                </a>
                <button 
                    type="button"
                    onclick="showConfirmModal()"
                    class="btn-primary text-white px-8 py-3 rounded-xl font-semibold shadow-lg inline-flex items-center"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Submit Vote
                </button>
            </div>
        </form>
        {% else %}
        <div class="glass-effect rounded-2xl shadow-lg p-8 mb-8 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Election Not Active</h3>
            <p class="text-slate-600">This election is not currently active for voting.</p>
        </div>
        {% endif %}

<!-- Confirmation Modal -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="glass-effect rounded-2xl shadow-2xl p-8 max-w-lg w-full fade-in">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-amber-100 rounded-full mb-4">
                <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-slate-900 mb-2">Confirm Your Vote</h3>
            <p class="text-slate-600 leading-relaxed">
                Are you sure you want to submit your vote? This action is irreversible and your choices cannot be changed after submission.
            </p>
        </div>
        
        <div class="bg-slate-50 rounded-xl p-4 mb-6">
            <h4 class="font-semibold text-slate-900 mb-3">Your Selections:</h4>
            <ul id="selections-list" class="space-y-2 text-sm">
                <!-- Selections will be populated by JavaScript -->
            </ul>
        </div>
        
        <div class="flex gap-3">
            <button 
                onclick="hideConfirmModal()"
                class="flex-1 px-6 py-3 bg-white border-2 border-slate-300 text-slate-700 rounded-xl font-semibold hover:shadow-lg transition"
            >
                Go Back
            </button>
            <button 
                onclick="submitVote()"
                class="flex-1 btn-accent text-white px-6 py-3 rounded-xl font-semibold shadow-lg"
            >
                Confirm Vote
            </button>
        </div>
    </div>
</div>

{{ positions_data|json_script:"positions-data" }}
<script>
function showConfirmModal() {
    const selectionsList = document.getElementById('selections-list');
    selectionsList.innerHTML = '';
    
    // Get all positions and their selected candidates
    const positions = JSON.parse(document.getElementById('positions-data').textContent);
    let hasSelection = false;
    
    positions.forEach(position => {
        const radio = document.querySelector(`input[name="position_${position.id}"]:checked`);
        if (radio) {
            hasSelection = true;
            const candidateId = radio.value;
            const candidate = position.candidates.find(c => c.id == candidateId);
            
            const li = document.createElement('li');
            li.className = 'flex items-center text-slate-700';
            li.innerHTML = `
                <svg class="w-4 h-4 text-emerald-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span><strong>${position.title}:</strong> ${candidate.full_name}</span>
            `;
            selectionsList.appendChild(li);
        }
    });
    
    if (!hasSelection) {
        const li = document.createElement('li');
        li.className = 'text-slate-500 italic';
        li.textContent = 'No candidates selected';
        selectionsList.appendChild(li);
    }
    
    document.getElementById('confirm-modal').classList.remove('hidden');
}

function hideConfirmModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
}

function submitVote() {
    // Submit the voting form
    document.getElementById('voting-form').submit();
}

// Countdown timer
function updateCountdown() {
    const endDate = new Date({{ end_timestamp }});
    const now = new Date();
    const timeLeft = endDate - now;

    if (timeLeft > 0) {
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        let countdownText = '';
        if (days > 0) countdownText += days + 'd ';
        if (hours > 0 || days > 0) countdownText += hours + 'h ';
        if (minutes > 0 || hours > 0 || days > 0) countdownText += minutes + 'm ';
        countdownText += seconds + 's';

        document.getElementById('countdown-timer').textContent = countdownText;
    } else {
        document.getElementById('countdown-timer').textContent = 'Election Ended';
        // Disable voting form if election has ended
        document.getElementById('voting-form').style.display = 'none';
        const endedMessage = document.createElement('div');
        endedMessage.className = 'text-center py-8';
        endedMessage.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-6"><h3 class="text-lg font-semibold text-red-800 mb-2">Election Ended</h3><p class="text-red-600">This election has ended and voting is no longer available.</p></div>';
        document.querySelector('form').parentNode.insertBefore(endedMessage, document.querySelector('form'));
    }
}

// Update countdown every second
{% if is_active %}
setInterval(updateCountdown, 1000);
updateCountdown(); // Initial call
{% endif %}
</script>
{% endblock %}
