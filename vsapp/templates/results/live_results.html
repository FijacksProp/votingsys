{% extends 'base.html' %}

{% block title %}Live Results - Campus E-Voting System{% endblock %}

{% block extra_styles %}
<style>
    .pulse-dot {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: .5;
        }
    }
    
    .countdown-container.ended {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 1px solid #fca5a5;
    }
    
    .countdown-container.ended h3 {
        color: #dc2626;
    }
    
    .countdown-container.ended .bg-purple-100 {
        background-color: #fef2f2;
    }
    
    .countdown-container.ended .text-purple-600 {
        color: #dc2627;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Election change function - defined in head to be available for inline handlers
function changeElection(electionId) {
    window.location.assign(window.location.origin + '/live_results/?election=' + electionId);
}
</script>
{% endblock %}

{% block content %}
<section class="py-12 px-4">
    {% include 'results/partials/live_results_content.html' %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
let countdownInterval = null;

function updateCountdown() {
    const container = document.getElementById('live-results-content');
    if (!container) return;

    const endTs = parseInt(container.dataset.endTs || '0', 10);
    if (!endTs) return;

    const endDate = new Date(endTs);
    const now = new Date();
    const timeLeft = endDate - now;

    const timer = document.getElementById('countdown-timer');
    const countdownContainer = document.querySelector('.countdown-container');

    if (timeLeft > 0) {
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        let countdownText = '';
        if (days > 0) countdownText += days + 'd ';
        if (hours > 0 || days > 0) countdownText += hours + 'h ';
        if (minutes > 0 || hours > 0 || days > 0) countdownText += minutes + 'm ';
        countdownText += seconds + 's';

        if (timer) {
            timer.textContent = countdownText;
        }
        if (countdownContainer) {
            countdownContainer.classList.remove('ended');
        }
    } else {
        if (timer) {
            timer.textContent = 'Election Ended';
        }
        if (countdownContainer) {
            countdownContainer.classList.add('ended');
        }
    }
}

function initCharts() {
    document.querySelectorAll('canvas[id^="chart-"]').forEach((canvas) => {
        const labels = JSON.parse(canvas.dataset.labels || '[]');
        const values = JSON.parse(canvas.dataset.values || '[]');

        if (canvas._chart) {
            canvas._chart.destroy();
        }

        const data = {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: [
                    '#3B82F6','#EF4444','#10B981','#F59E0B','#8B5CF6',
                    '#06B6D4','#F97316','#84CC16','#EC4899','#6B7280'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        };

        canvas._chart = new Chart(canvas, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' votes (' + percentage + '%)';
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    });
}

function initLiveResults() {
    updateCountdown();
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    countdownInterval = setInterval(updateCountdown, 1000);
    initCharts();
}

document.addEventListener('DOMContentLoaded', initLiveResults);
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.target && event.target.id === 'live-results-content') {
        initLiveResults();
    }
});
</script>
{% endblock %}
